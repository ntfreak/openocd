# This is an STM32F723E discovery board with a single STM32F723IEK6 chip.
# http://www.st.com/en/evaluation-tools/32f723ediscovery.html

# This is for using the onboard STLINK/V2-1
source [find interface/stlink-v2-1.cfg]

transport select hla_swd

# increase working area to 128KB
set WORKAREASIZE 0x20000

source [find target/stm32f7x.cfg]

$_TARGETNAME configure -event reset-init {
	mww 0x40023C00 0x00000006				;# 6 WS for 192 MHz HCLK
	sleep 1
	mww 0x40023804 0x24003008				;# 192MHz: PLLM=8, PLLN=192, PLLP=2
	mww 0x40023808 0x00009400				;# APB1: /4, APB2: /2
	mmw 0x40023800 0x01000000 0x00000000	;# PLL on
	sleep 1
	mmw 0x40023808 0x00000002 0x00000000	;# switch to PLL

	adapter_khz 4000

	# QUADSPI initialization
	mmw 0x40023830 0x000007FF 0				;# RCC_AHB1ENR |= GPIOA-GPIOK (enable clocks)
	mmw 0x40023838 0x00000002 0				;# RCC_AHB3ENR |= QSPIEN (enable clock)
	sleep 1									;# Wait for clock startup

	# PB2: CLK, PB6: BK1_nCS, PD13: BK1_IO3, PE2: BK1_IO2, PC10: BK1_IO1, PC9: BK1_IO0
	mmw 0x40020400 0x00002020 0x00001010	;# PB6, PB2 alternate
	mmw 0x40020408 0x00003030 0x00000000	;# high speed
	mmw 0x40020420 0x0A000900 0x05000600	;# AF10, AF9

	mmw 0x40020800 0x00280000 0x00140000	;# PC10, PC9 alternate
	mmw 0x40020808 0x003C0000 0x00000000	;# high speed
	mmw 0x40020824 0x00000990 0x00000660	;# AF9, AF9

	mmw 0x40020C00 0x08000000 0x04000000	;# PD13 alternate
	mmw 0x40020C08 0x0C000000 0x00000000	;# high speed
	mmw 0x40020C24 0x00900000 0x00600000	;# AF9

	mmw 0x40021000 0x00000020 0x00000010	;# PE2 alternate
	mmw 0x40021008 0x00000030 0x00000000	;# high speed
	mmw 0x40021020 0x00000900 0x00000600	;# AF9

	mww 0xA0001004 0x00190100				;# QUADSPI_DCR: FSIZE=0x19, CSHT=0x01, CKMODE=0
	mww 0xA0001000 0x03500000				;# QUADSPI_CR: PRESCALER=4, APMS=1, FTHRES=0, SSHIFT=0, TCEN=0
	mmw 0xA0001000 0x00000001 0				;# QUADSPI_CR: EN=1

	# 1-line spi mode
	mww 0xA0001014 0x000003F5				;# QUADSPI_CCR: FMODE=0x0, DMODE=0x0, DCYC=0x0, ADSIZE=0x0, ADMODE=0x0, IMODE=0x3, INSTR=RSTQIO
	sleep 1

	# 4-byte address mode
	mww 0xA0001014 0x000001B7				;# QUADSPI_CCR: FMODE=0x0, DMODE=0x0, DCYC=0x0, ADSIZE=0x0, ADMODE=0x0, IMODE=0x1, INSTR=EN4B
	sleep 1

	# memory-mapped read mode with 4-byte addresses
	mww 0xA0001014 0x0D003503				;# QUADSPI_CCR: FMODE=0x3, DMODE=0x1, DCYC=0x0, ADSIZE=0x3, ADMODE=0x1, IMODE=0x1, INSTR=READ
}
