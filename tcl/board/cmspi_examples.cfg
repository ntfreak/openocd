--------------------------------------------------------------------------------
for a STM32F030F4P6 minimum board:
--------------------------------------------------------------------------------
set _MSOFTSPINAME $_CHIPNAME.cmspi
flash bank $_MSOFTSPINAME cmspi 0x90000000 0 0 0 $_TARGETNAME 0xFC \
	0x48000414 1 0x48000014 5 0x00000000 0 0x00000000 0 0x48000014 6 0x48000014 7

proc cmspi_init { } {
	# RCC_AHBENR |= IOPFEN|IOPDEN|IOPCEN|IOPBEN|IOPAEN
	mmw 0x40021014 0x005E0000 0
	sleep 1

	# NCS: PB01, CLK: PA05, MISO: PA06, MOSI: PA07, LED: PA04
	# PA07:PP:V, PA06:INUP:V, PA05:PP:V, PA04:PP:M, PB01:PP:V
	# Port A: PA07:PP:V, PA06:INUP:V, PA05:PP:V, PA04:PP:M
	mmw 0x48000000 0x00004500 0x0000BA00	;# MODER
	mmw 0x48000004 0x00000000 0x000000B0	;# OTYPER
	mmw 0x48000008 0x0000FD00 0x00000200	;# OSPEEDR
	mmw 0x4800000C 0x00001000 0x0000EF00	;# PUPDR
	# Port B: PB01:PP:V
	mmw 0x48000400 0x00000004 0x00000008	;# MODER
	mmw 0x48000404 0x00000000 0x00000002	;# OTYPER
	mmw 0x48000408 0x0000000C 0x00000000	;# OSPEEDR
	mmw 0x4800040C 0x00000000 0x0000000C	;# PUPDR
}

$_TARGETNAME configure -event reset-init {
	mww 0x40022000 0x00000011				;# FLASH_ACR: PRFTBE=1, 1 WS for 48 MHz HCLK
	mww 0x40021004 0x00280000				;# 48 MHz: RCC_CFGR: MCO=none, PLLMUL=12, PLLSRC=HSI/2, APB1=/1, AHB=/1
	mmw 0x40021000 0x01000000 0x00000000	;# RCC_CR: PLL on
	sleep 1
	mmw 0x40021004 0x00000002 0x00000001	;# RCC_CFGR: SW=PLL
	sleep 1

	adapter_khz 4000

}
--------------------------------------------------------------------------------
for a STM32F407VET6 board:
--------------------------------------------------------------------------------
set _MSOFTSPINAME $_CHIPNAME.cmspi
flash bank $_MSOFTSPINAME cmspi 0x90000000 0 0 0 $_TARGETNAME \
	0xFC 0x40020414  0 0x40020414  3 \
	0x00000000  0 0xFF 0x00000000 0x00000000  0 0xFF 0x00000000 \
	0x40020414  4 0xEC 0x00000100 0x40020414  5 0xEC 0x00000400

proc cmspi_init { } {
	mmw 0x40023830 0x000001FF 0				;# RCC_AHB1ENR |= GPIOA-GPIOI (enable clocks)
	sleep 1

	# NCS: PB00, CLK: PB03, IO1/MISO: PB04, IO0/MOSI: PB05
	# PB05:INUP:V, PB04:INUP:V, PB03:PP:V, PB00:PP:M
	# Port B: PB05:INUP:V, PB04:INUP:V, PB03:PP:V, PB00:PP:M
	mmw 0x40020400 0x00000041 0x00000F82    ;# MODER
	mmw 0x40020404 0x00000000 0x00000009    ;# OTYPER
	mmw 0x40020408 0x00000FC1 0x00000002    ;# OSPEEDR
	mmw 0x4002040C 0x00000500 0x00000AC3    ;# PUPDR
}

$_TARGETNAME configure -event reset-init {
	mww 0x40023C00 0x00000005				;# 5 WS for up to 168 MHz HCLK
	mmw 0x40007000 0x00004000 0				;# PWR_CR |= VOS: Scale Mode 1 for up to 168 MHz HCLK
	sleep 1
	mww 0x40023804 0x26002408				;# 144 MHz: PLLM=8, PLLN=144, PLLP=2, PLLQ=6
	mww 0x40023808 0x3F609400				;# APB1: /4, APB2: /2
	mmw 0x40023800 0x01000000 0x00000000	;# PLL on
	sleep 1
	mmw 0x40023808 0x00000002 0x00000000	;# switch to PLL

	adapter_khz 4000

	cmspi_init
	cmspi cmd 1 3 0x9F
}

--------------------------------------------------------------------------------
for STM32F469I-disco:
--------------------------------------------------------------------------------

set _MSOFTSPINAME $_CHIPNAME.cmspi
flash bank $_MSOFTSPINAME cmspi 0x90000000 0 0 0 $_TARGETNAME \
	0xFC 0x40020414  6 0x40021414 10 \
	0x40021414  6 0xEC 0x00001000 0x40021414  7 0xEC 0x00004000 \
	0x40021414  9 0xEC 0x00040000 0x40021414  8 0xEC 0x00010000

proc cmspi_init { } {
	mmw 0x40023830 0x000007FF 0				;# RCC_AHB1ENR |= GPIOA-GPIOK (enable clocks)
	sleep 1									;# Wait for clock startup

	# NCS: PB06, CLK: PF10, IO3/NHOLD: PF06, IO2/NWP: PF07, IO1/MISO: PF09, IO0/MOSI: PF08
	# PB06:PP:M, PF10:PP:V, PF09:INUP:V, PF08:INUP:V, PF07:INUP:V, PF06:INUP:V
	# Port B: PB06:PP:M
	mmw 0x40020400 0x00001000 0x00002000    ;# MODER
	mmw 0x40020404 0x00000000 0x00000040    ;# OTYPER
	mmw 0x40020408 0x00001000 0x00002000    ;# OSPEEDR
	mmw 0x4002040C 0x00000000 0x00003000    ;# PUPDR
	# Port F: PF10:PP:V, PF09:INUP:V, PF08:INUP:V, PF07:INUP:V, PF06:INUP:V
	mmw 0x40021400 0x00100000 0x002FF000    ;# MODER
	mmw 0x40021404 0x00000000 0x00000400    ;# OTYPER
	mmw 0x40021408 0x003FF000 0x00000000    ;# OSPEEDR
	mmw 0x4002140C 0x00055000 0x003AA000    ;# PUPDR
}

$_TARGETNAME configure -event reset-init {
	mww 0x40023C00 0x00000005				;# 5 WS for 160 MHz HCLK
	sleep 1
	mww 0x40023804 0x24002808				;# 160M Hz: HSI, PLLM=8, PLLN=160, PLLP=2
	mww 0x40023808 0x00009400				;# APB1: /4, APB2: /2
	mmw 0x40023800 0x01000000 0x00000000	;# PLL on
	sleep 1
	mmw 0x40023808 0x00000002 0x00000000	;# switch to PLL
	sleep 1

	adapter_khz 4000

	cmspi_init
	cmspi qpi 1 10; cmspi cmd 1 3 0x9F; cmspi spi 1; cmspi cmd 1 3 0x9F
	cmspi cmd 1 0 0x06; cmspi cmd 1 0 0x61 0x5F; cmspi qpi 1 10; cmspi cmd 1 3 0xAF;
	cmspi cmd 1 1 0x85; cmspi cmd 1 1 0x65
}

--------------------------------------------------------------------------------
for STM32F746G-disco:
--------------------------------------------------------------------------------

set _MSOFTSPINAME $_CHIPNAME.cmspi
flash bank $_MSOFTSPINAME cmspi 0x90000000 0 0 0 $_TARGETNAME \
	0xFC 0x40020414  6 0x40020414  2 \
	0x40020C14 13 0xEC 0x04000000 0x40021014  2 0xEC 0x00000010 \
	0x40020C14 12 0xEC 0x01000000 0x40020C14 11 0xEC 0x00400000

proc cmspi_init { } {
	mmw 0x40023830 0x000007FF 0				;# RCC_AHB1ENR |= GPIOA-GPIOK (enable clocks)

	# NCS: PB06, CLK: PB02, IO3/NHOLD: PD13, IO2/NWP: PE02, IO1/MISO: PD12, IO0/MOSI: PD11
	# PB06:PP:M, PB02:PP:V, PD13:INUP:V, PD12:INUP:V, PD11:INUP:V, PE02:INUP:V
	# Port B: PB06:PP:M, PB02:PP:V
	mmw 0x40020400 0x00001010 0x00002020	;# MODER
	mmw 0x40020404 0x00000000 0x00000044	;# OTYPER
	mmw 0x40020408 0x00001030 0x00002000	;# OSPEEDR
	mmw 0x4002040C 0x00000000 0x00003030	;# PUPDR
	# Port D: PD13:INUP:V, PD12:INUP:V, PD11:INUP:V
	mmw 0x40020C00 0x00000000 0x0FC00000	;# MODER
	mmw 0x40020C08 0x0FC00000 0x00000000	;# OSPEEDR
	mmw 0x40020C0C 0x05400000 0x0A800000	;# PUPDR
	# Port E: PE02:INUP:V
	mmw 0x40021000 0x00000000 0x00000030	;# MODER
	mmw 0x40021008 0x00000030 0x00000000	;# OSPEEDR
	mmw 0x4002100C 0x00000010 0x00000020	;# PUPDR
}

$_TARGETNAME configure -event reset-init {

	mww 0x40023C00 0x00000006				;# 6 WS for 192 MHz HCLK
	sleep 1
	mww 0x40023804 0x24003008				;# 192 MHz: PLLM=8, PLLN=192, PLLP=2
	mww 0x40023808 0x00009400				;# APB1: /4, APB2: /2
	mmw 0x40023800 0x01000000 0x00000000	;# PLL on
	sleep 1
	mmw 0x40023808 0x00000002 0x00000000	;# switch to PLL

	adapter_khz 4000

	cmspi_init
	# the N25Q128 switches automatically back to SPI when receiving RDID 0x9F --- undocumented
	cmspi qpi 1 10; cmspi cmd 1 3 0x9F; cmspi spi 1; cmspi cmd 1 3 0x9F

	# switch to DPI mode, read id
	#cmspi cmd 1 0 0x06; cmspi cmd 1 0 0x61 0x9F; cmspi dpi 1 10; cmspi cmd 1 3 0xAF;

	# switch to QPI mode, read id
	cmspi cmd 1 0 0x06; cmspi cmd 1 0 0x61 0x5F; cmspi qpi 1 10; cmspi cmd 1 3 0xAF;

	# read  'Volatile Configuration Register' and 'Volatile Enhanced Configuration Register'
	cmspi cmd 1 1 0x85; cmspi cmd 1 1 0x65
}

--------------------------------------------------------------------------------
for STM32F769I-disco:
--------------------------------------------------------------------------------

set _MSOFTSPINAME $_CHIPNAME.cmspi
flash bank $_MSOFTSPINAME cmspi 0x90000000 0 0 0 $_TARGETNAME \
	0xFC 0x40020414  6 0x40020414  2 \
	0x40020C14 13 0xEC 0x04000000 0x40021014  2 0xEC 0x00000010 \
	0x40020814 10 0xEC 0x00100000 0x40020814  9 0xEC 0x00040000

proc cmspi_init { } {
	mmw 0x40023830 0x000007FF 0				;# RCC_AHB1ENR |= GPIOA-GPIOK (enable clocks)
	mmw 0x40023838 0x00000002 0				;# RCC_AHB3ENR |= QSPIEN (enable clock)
	sleep 1

	# NCS: PB06, CLK: PB02, IO3/NHOLD: PD13, IO2/NWP: PE02, IO1/MISO: PC10, IO0/MOSI: PC09
	# PB06:PP:M, PB02:PP:V, PC10:INUP:V, PC09:INUP:V, PD13:INUP:V, PE02:INUP:V
	# Port B: PB06:PP:M, PB02:PP:V
	mmw 0x40020400 0x00001010 0x00002020    ;# MODER
	mmw 0x40020404 0x00000000 0x00000044    ;# OTYPER
	mmw 0x40020408 0x00001030 0x00002000    ;# OSPEEDR
	mmw 0x4002040C 0x00000000 0x00003030    ;# PUPDR
	# Port C: PC10:INUP:V, PC09:INUP:V
	mmw 0x40020800 0x00000000 0x003C0000    ;# MODER
	mmw 0x40020808 0x003C0000 0x00000000    ;# OSPEEDR
	mmw 0x4002080C 0x00140000 0x00280000    ;# PUPDR
	# Port D: PD13:INUP:V
	mmw 0x40020C00 0x00000000 0x0C000000    ;# MODER
	mmw 0x40020C08 0x0C000000 0x00000000    ;# OSPEEDR
	mmw 0x40020C0C 0x04000000 0x08000000    ;# PUPDR
	# Port E: PE02:INUP:V
	mmw 0x40021000 0x00000000 0x00000030    ;# MODER
	mmw 0x40021008 0x00000030 0x00000000    ;# OSPEEDR
	mmw 0x4002100C 0x00000010 0x00000020    ;# PUPDR

	# if demo firmware is installed, it will switch the SPI flash to QPI mode, which
	# which will remain active until power-cycling, hence QPI mode must be turned off first
	cmspi qpi 1 10					;# switch to QPI mode with 10 dummy cycles
	cmspi cmd 1 0 0xF5				;# RSTQIO: leave QPI mode
	cmspi spi 1						;# back to SPI mode

	cmspi cmd 1 0 0xB7				;# EN4B: switch to 4-byte address mode
	cmspi cmd 1 1 0x15				;# RDCR: read configuration register

	cmspi cmd 1 0 0x35				;# EQIO: enter QPI mode
	cmspi qpi 1 10					;# switch to QPI mode with 10 dummy cycles
	cmspi cmd 1 3 0xAF				;# QPIID: read ID
}

$_TARGETNAME configure -event reset-init {
	mww 0x40023C00 0x00000006				;# 6 WS for 192 MHz HCLK
	sleep 1
	mww 0x40023804 0x24003008				;# 192MHz: PLLM=8, PLLN=192, PLLP=2
	mww 0x40023808 0x00009400				;# APB1: /4, APB2: /2
	mmw 0x40023800 0x01000000 0x00000000	;# PLL on
	sleep 1
	mmw 0x40023808 0x00000002 0x00000000	;# switch to PLL

	adapter_khz 4000

	cmspi_init
}
