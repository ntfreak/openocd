--------------------------------------------------------------------------------
for STM32F469I-disco:
--------------------------------------------------------------------------------

set _MSOFTSPINAME $_CHIPNAME.msoftspi
flash bank $_MSOFTSPINAME msoftspi 0x90000000 0 0 0 $_TARGETNAME 0x40020414 6 0x40021414 10 0x40021410 9 0x40021414 8

$_TARGETNAME configure -event reset-init {
	mww 0x40023C00 0x00000005		;# 5 WS for 160 MHz HCLK
	sleep 1
	mww 0x40023804 0x24002808		;# 160MHz: HSI, PLLM=8, PLLN=160, PLLP=2
	mww 0x40023808 0x00009400		;# APB1: /4, APB2: /2
	mmw 0x40023800 0x01000000 0x00000000	;# PLL on
	sleep 1
	mmw 0x40023808 0x00000002 0x00000000	;# switch to PLL
	sleep 1

	adapter_khz 4000

	mmw 0x40023830 0x000007FF 0		;# RCC_AHB1ENR |= GPIOA-GPIOK (enable clocks)
	sleep 1					;# Wait for clock startup

	# PF10: CLK, PB6: BK1_nCS, PF6: BK1_IO3, PF7: BK1_IO2, PF9: BK1_IO1 (MISO), PF8: BK1_IO0 (MOSI)
	mmw 0x40020400 0x00001000 0x00002000	;# PB6 output
	mmw 0x40020404 0x00000000 0x00000040	;# PB6 push-pull
	mmw 0x40020408 0x00003000 0x00000000	;# very high speed
	mmw 0x4002040C 0x00000000 0x00003000	;# PB6 no pull-up


	mmw 0x40021400 0x00110000 0x002EF000	;# PF10, PF8 output, PF9, PF7, PF6 input
	mmw 0x40021404 0x00000000 0x00000500	;# PF10, PF8 push-pull
	mmw 0x40021408 0x00330000 0x00000000	;# very high speed
	mmw 0x4002140C 0x00045000 0x003BA000	;# PF10, PF8 no pull-up, PF9, PF7, PF6 pull-up
}

--------------------------------------------------------------------------------
for STM32F746G-disco:
--------------------------------------------------------------------------------

set _MSOFTSPINAME $_CHIPNAME.msoftspi
flash bank $_MSOFTSPINAME msoftspi 0x90000000 0 0 0 $_TARGETNAME 0x40020414 6 0x40020414 2 0x40020C10 12 0x40020C14 11

$_TARGETNAME configure -event reset-init {
	mmw 0x40023830 0x000007FF 0		;# RCC_AHB1ENR |= GPIOA-GPIOK (enable clocks)

	mww 0x40023C00 0x00000006		;# 6 WS for 192 MHz HCLK
	sleep 1
	mww 0x40023804 0x24003008		;# 192MHz: PLLM=8, PLLN=192, PLLP=2
	mww 0x40023808 0x00009400		;# APB1: /4, APB2: /2
	mmw 0x40023800 0x01000000 0x00000000	;# PLL on
	sleep 1
	mmw 0x40023808 0x00000002 0x00000000	;# switch to PLL

	adapter_khz 4000

	# PB2: CLK, PB6: BK1_nCS, PD13: BK1_IO3, PE2: BK1_IO2, PD12: BK1_IO1 (MISO), PD11: BK1_IO0 (MOSI)
	mmw 0x40020400 0x00001010 0x00002020	;# PB6, PB2 output
	mmw 0x40020404 0x00000000 0x00000044	;# PB6, PB2 push-pull
	mmw 0x40020408 0x00003030 0x00000000	;# very high speed
	mmw 0x4002040C 0x00000000 0x00003030	;# PB6, PB2 no pull-up

	mmw 0x40020C00 0x00400000 0x03800000	;# PD13 input, PD12 input, PD11 output
	mmw 0x40020C04 0x00000000 0x08000000	;# PD11 push-pull
	mmw 0x40020C08 0x00C00000 0x00000000	;# PD11 very high speed
	mmw 0x40020C0C 0x05000000 0x0A000000	;# PD13, PD12 pull-up, PD11 no pull-up

	mmw 0x40021000 0x00000000 0x00000300	;# PE2 input
	mmw 0x40021004 0x00000000 0x00000000	;#
	mmw 0x40021008 0x00000000 0x00000000	;# very high speed
	mmw 0x4002100C 0x05000000 0x0A000000	;# PE2 pull-up
}

--------------------------------------------------------------------------------
for STM32F769I-disco:
--------------------------------------------------------------------------------

set _MSOFTSPINAME $_CHIPNAME.msoftspi
flash bank $_MSOFTSPINAME msoftspi 0x90000000 0 0 0 $_TARGETNAME 0x40020414 6 0x40020414 2 0x40020810 10 0x40020814 9

$_TARGETNAME configure -event reset-init {
	mmw 0x40023830 0x000007FF 0		;# RCC_AHB1ENR |= GPIOA-GPIOK (enable clocks)
	mmw 0x40023838 0x00000002 0		;# RCC_AHB3ENR |= QSPIEN (enable clock)
	sleep 1

	# if demo firmware is installed, it will switch the SPI flash to QPI mode,
	# which will remain active until power-cycling
	# hence QPI mode must be turned off ...

	# PB2: CLK, PB6: BK1_nCS, PD13: BK1_IO3, PE2: BK1_IO2, PC10: BK1_IO1, PC9: BK1_IO0
	mmw 0x40020400 0x00002020 0x00001010	;# PB6, PB2 alternate
	mmw 0x40020408 0x00003030 0x00000000	;# high speed
	mmw 0x40020420 0x0A000900 0x05000600	;# PB6: AF10, PB2: AF9

	mmw 0x40020800 0x00280000 0x00140000	;# PC10, PC9 alternate
	mmw 0x40020808 0x003C0000 0x00000000	;# very high speed
	mmw 0x40020824 0x00000990 0x00000660	;# PC10: AF9, PC9: AF9

	mmw 0x40020C00 0x08000000 0x04000000	;# PD13 alternate
	mmw 0x40020C08 0x0C000000 0x00000000	;# very high speed
	mmw 0x40020C24 0x00900000 0x00600000	;# PD13: AF9

	mmw 0x40021000 0x00000020 0x00000010	;# PE2 alternate
	mmw 0x40021008 0x00000030 0x00000000	;# very high speed
	mmw 0x40021020 0x00000900 0x00000600	;# PE2: AF9

	mww 0xA0001000 0x01500318		;# QUADSPI_CR: PRESCALER=1, APMS=1, FTHRES=3, SSHIFT=1, TCEN=1
	mww 0xA0001004 0x00190100		;# QUADSPI_DCR: FSIZE=0x19, CSHT=0x01, CKMODE=0
	mmw 0xA0001000 0x00000001 0		;# QUADSPI_CR: EN=1

	# 1-line spi mode
	mww 0xA0001014 0x000003F5		;# QUADSPI_CCR: FMODE=0x0, DMODE=0x0, DCYC=0x0, ADSIZE=0x0, ADMODE=0x0, IMODE=0x3, INSTR=RS
	sleep 1

	# 4-byte address mode
	mww 0xA0001014 0x000001B7		;# QUADSPI_CCR: FMODE=0x0, DMODE=0x0, DCYC=0x0, ADSIZE=0x0, ADMODE=0x0, IMODE=0x1, INSTR=EN
	sleep 1

	# memory-mapped read mode with 4-byte addresses
	mww 0xA0001014 0x0D003503		;# QUADSPI_CCR: FMODE=0x3, DMODE=0x1, DCYC=0x0, ADSIZE=0x3, ADMODE=0x1, IMODE=0x1, INSTR=RE


	mww 0x40023C00 0x00000006		;# 6 WS for 192 MHz HCLK
	sleep 1
	mww 0x40023804 0x24003008		;# 192MHz: PLLM=8, PLLN=192, PLLP=2
	mww 0x40023808 0x00009400		;# APB1: /4, APB2: /2
	mmw 0x40023800 0x01000000 0x00000000	;# PLL on
	sleep 1
	mmw 0x40023808 0x00000002 0x00000000	;# switch to PLL

	# PB2: CLK, PB6: BK1_nCS, PD13: BK1_IO3, PE2: BK1_IO2, PC10: BK1_IO1 (MISO), PC9: BK1_IO0 (MOSI)
	mmw 0x40020400 0x00001010 0x00002020	;# PB6, PB2 output
	mmw 0x40020404 0x00000000 0x00000044	;# PB6, PB2 push-pull
	mmw 0x40020408 0x00003030 0x00000000	;# very high speed
	mmw 0x4002040C 0x00000000 0x00003030	;# PB6, PB2 no pull-up

	mmw 0x40020800 0x00040000 0x00380000	;# PC10 input, PC9 output
	mmw 0x40020804 0x00000000 0x00000200	;# PC9 push-pull
	mmw 0x40020808 0x000C0000 0x00000000	;# very high speed
	mmw 0x4002080C 0x00100000 0x002C0000	;# PC10 pull-up, PC9 no-pullup

	mmw 0x40020C00 0x00000000 0x0C000000	;# PD13 input
	mmw 0x40020C04 0x00000000 0x00000000	;#
	mmw 0x40020C08 0x00000000 0x00000000	;# very high speed
	mmw 0x40020C0C 0x04000000 0x08000000	;# PD13 pull-up

	mmw 0x40021000 0x00000000 0x00000030	;# PE2 input
	mmw 0x40021004 0x00000000 0x00000000	;#
	mmw 0x40021008 0x00000000 0x00000000	;# very high speed
	mmw 0x4002100C 0x00000010 0x00000020	;# PE2 pull-up

	sleep 1
	msoftspi spicmd 1 0 0xB7		;# EN4B: switch to 4-byte address mode
	msoftspi spicmd 1 1 0x15		;# RDCR: read configuration register
}
