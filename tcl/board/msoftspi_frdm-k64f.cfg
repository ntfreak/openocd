# Sample configs for SPI Flash, EEPROMs and FRAMs with frdm-f103rb

source [find interface/cmsis-dap.cfg]

# increase working area to 16KB
set WORKAREASIZE 0x4000

# chip name
set CHIPNAME MK64FN1M0VLL12

source [find mem_helper.tcl]

source [find target/kx.cfg]

kinetis create_banks

cortex_m reset_config sysresetreq

# mmb: "memory modify byte", updates value of $reg
#       $reg <== ((value & ~$clearbits) | $setbits)
proc mmb {reg setbits clearbits} {
        set old [mrb $reg]
        set new [expr ($old & ~$clearbits) | $setbits]
        mwb $reg $new
}

# W25Q128
flash bank $_CHIPNAME.w25q128 msoftspi 0x90000000 0 0 0 $_TARGETNAME \
	0x10 0x400FF080 10 0x400FF040  2 \
	0x00000000  0 0xFF 0x00000000 0x00000000  0 0xFF 0x00000000 \
	0x400FF040  3 0x14 0x00000008 0x400FF080 11 0x14 0x00000800

# W25Q256
flash bank $_CHIPNAME.w25q256 msoftspi 0x91000000 0 0 0 $_TARGETNAME \
	0x10 0x400FF040 10 0x400FF040  2 \
	0x00000000  0 0xFF 0x00000000 0x00000000  0 0xFF 0x00000000 \
	0x400FF040  3 0x14 0x00000008 0x400FF080 11 0x14 0x00000800

# M95640
flash bank $_CHIPNAME.m95640 msoftspi 0x93000000 0 0 0 $_TARGETNAME \
	0x10 0x400FF080  3 0x400FF040  2 \
	0x00000000  0 0xFF 0x00000000 0x00000000  0 0xFF 0x00000000 \
	0x400FF040  3 0x14 0x00000008 0x400FF080 11 0x14 0x00000800

# M95M02
flash bank $_CHIPNAME.m95m02 msoftspi 0x93002000 0 0 0 $_TARGETNAME \
	0x10 0x400FF040  9 0x400FF040  2 \
	0x00000000  0 0xFF 0x00000000 0x00000000  0 0xFF 0x00000000 \
	0x400FF040  3 0x14 0x00000008 0x400FF080 11 0x14 0x00000800

# M95512
flash bank $_CHIPNAME.m95512 msoftspi 0x93042000 0 0 0 $_TARGETNAME \
	0x10 0x400FF040 11 0x400FF040  2 \
	0x00000000  0 0xFF 0x00000000 0x00000000  0 0xFF 0x00000000 \
	0x400FF040  3 0x14 0x00000008 0x400FF080 11 0x14 0x00000800

# FM25W256
flash bank $_CHIPNAME.fm25w256 msoftspi 0x93052000 0 0 0 $_TARGETNAME \
	0x10 0x400FF000  1 0x400FF040  2 \
	0x00000000  0 0xFF 0x00000000 0x00000000  0 0xFF 0x00000000 \
	0x400FF040  3 0x14 0x00000008 0x400FF080 11 0x14 0x00000800

# MB85RS64
flash bank $_CHIPNAME.mb85rs64 msoftspi 0x9305A000 0 0 0 $_TARGETNAME \
	0x10 0x400FF000  2 0x400FF040  2 \
	0x00000000  0 0xFF 0x00000000 0x00000000  0 0xFF 0x00000000 \
	0x400FF040  3 0x14 0x00000008 0x400FF080 11 0x14 0x00000800

# FM25V02
#
# MOSI and MISO pins *both* connected to PC01, hence exor mask
# for MISO is 0x00000000 rather than 0x00000008
#
flash bank $_CHIPNAME.fm25v02 msoftspi 0x9305C000 0 0 0 $_TARGETNAME \
	0x10 0x400FF040 23 0x400FF040  2 \
	0x00000000  0 0xFF 0x00000000 0x00000000  0 0xFF 0x00000000 \
	0x400FF080 11 0x14 0x00000000 0x400FF080 11 0x14 0x00000800

# FM25V05
flash bank $_CHIPNAME.fm25v05 msoftspi 0x93064000 0 0 0 $_TARGETNAME \
	0x10 0x400FF080  2 0x400FF040  2 \
	0x00000000  0 0xFF 0x00000000 0x00000000  0 0xFF 0x00000000 \
	0x400FF040  3 0x14 0x00000008 0x400FF080 11 0x14 0x00000800

proc msoftspi_init { } {
	mww 0x40048044 0x01220000				;# SIM_CLKDIV1: core: /1, bus: /2, flex: /3, flash: /3
	mmb 0x40064003 0x60 0x00				;# MCG_C4: DRST_DRS = 0b11 for approx 80 Mhz
	mmw 0x40048038 0x00003E00 0				;# SIM_SCGC5 |= PORTE|PORTD|PORTC|PORTB|PORTA

	# W25Q128, A5=NCS: PC10, A0=SCLK: PB02, A1=IO01/MISO: PB03, A4=IO00/MOSI: PC11
	# PB03:INPUP:H, PB02:PP:H, PC11:INPUP:H, PC10:PP:H
	# Port B: PB03:INPUP:H, PB02:PP:H
	mmw 0x4004A008 0x00000100 0x00000626	;# PORTB_PCR02
	mmw 0x4004A00C 0x00000103 0x00000624	;# PORTB_PCR03
	mmw 0x400FF040 0x0000000C 0x00000000	;# PODR
	mmw 0x400FF054 0x00000004 0x00000008	;# PDDR
	# Port C: PC11:INPUP:H, PC10:PP:H
	mmw 0x4004B028 0x00000100 0x00000626	;# PORTC_PCR10
	mmw 0x4004B02C 0x00000103 0x00000624	;# PORTC_PCR11
	mmw 0x400FF080 0x00000C00 0x00000000	;# PODR
	mmw 0x400FF094 0x00000400 0x00000800	;# PDDR

	# W25Q256, A2=NCS: PB10, A0=SCLK: PB02, A1=IO01/MISO: PB03, A4=IO00/MOSI: PC11
	# PB10:PP:H, PB03:INPUP:H, PB02:PP:H, PC11:INPUP:H
	# Port B: PB10:PP:H, PB03:INPUP:H, PB02:PP:H
	mmw 0x4004A008 0x00000100 0x00000626	;# PORTB_PCR02
	mmw 0x4004A00C 0x00000103 0x00000624	;# PORTB_PCR03
	mmw 0x4004A028 0x00000100 0x00000626	;# PORTB_PCR10
	mmw 0x400FF040 0x0000040C 0x00000000	;# PODR
	mmw 0x400FF054 0x00000404 0x00000008	;# PDDR
	# Port C: PC11:INPUP:H
	mmw 0x4004B02C 0x00000103 0x00000624	;# PORTC_PCR11
	mmw 0x400FF080 0x00000800 0x00000000	;# PODR
	mmw 0x400FF094 0x00000000 0x00000800	;# PDDR

	# M95640, D7=NCS: PC03, A0=SCLK: PB02, A1=IO01/MISO: PB03, A4=IO00/MOSI: PC11
	# PB03:INPUP:H, PB02:PP:H, PC11:INPUP:H, PC03:PP:H
	# Port B: PB03:INPUP:H, PB02:PP:H
	mmw 0x4004A008 0x00000100 0x00000626	;# PORTB_PCR02
	mmw 0x4004A00C 0x00000103 0x00000624	;# PORTB_PCR03
	mmw 0x400FF040 0x0000000C 0x00000000	;# PODR
	mmw 0x400FF054 0x00000004 0x00000008	;# PDDR
	# Port C: PC11:INPUP:H, PC03:PP:H
	mmw 0x4004B00C 0x00000100 0x00000626	;# PORTC_PCR03
	mmw 0x4004B02C 0x00000103 0x00000624	;# PORTC_PCR11
	mmw 0x400FF080 0x00000808 0x00000000	;# PODR
	mmw 0x400FF094 0x00000008 0x00000800	;# PDDR

	# M95M02, D2=NCS: PB09, A0=SCLK: PB02, A1=IO01/MISO: PB03, A4=IO00/MOSI: PC11
	# PB09:PP:H, PB03:INPUP:H, PB02:PP:H, PC11:INPUP:H
	# Port B: PB09:PP:H, PB03:INPUP:H, PB02:PP:H
	mmw 0x4004A008 0x00000100 0x00000626	;# PORTB_PCR02
	mmw 0x4004A00C 0x00000103 0x00000624	;# PORTB_PCR03
	mmw 0x4004A024 0x00000100 0x00000626	;# PORTB_PCR09
	mmw 0x400FF040 0x0000020C 0x00000000	;# PODR
	mmw 0x400FF054 0x00000204 0x00000008	;# PDDR
	# Port C: PC11:INPUP:H
	mmw 0x4004B02C 0x00000103 0x00000624	;# PORTC_PCR11
	mmw 0x400FF080 0x00000800 0x00000000	;# PODR
	mmw 0x400FF094 0x00000000 0x00000800	;# PDDR

	# M95512, A3=NCS: PB11, A0=SCLK: PB02, A1=IO01/MISO: PB03, A4=IO00/MOSI: PC11
	# PB11:PP:H, PB03:INPUP:H, PB02:PP:H, PC11:INPUP:H
	# Port B: PB11:PP:H, PB03:INPUP:H, PB02:PP:H
	mmw 0x4004A008 0x00000100 0x00000626	;# PORTB_PCR02
	mmw 0x4004A00C 0x00000103 0x00000624	;# PORTB_PCR03
	mmw 0x4004A02C 0x00000100 0x00000626	;# PORTB_PCR11
	mmw 0x400FF040 0x0000080C 0x00000000	;# PODR
	mmw 0x400FF054 0x00000804 0x00000008	;# PDDR
	# Port C: PC11:INPUP:H
	mmw 0x4004B02C 0x00000103 0x00000624	;# PORTC_PCR11
	mmw 0x400FF080 0x00000800 0x00000000	;# PODR
	mmw 0x400FF094 0x00000000 0x00000800	;# PDDR

	# FM25W256, D3=NCS: PA01, A0=SCLK: PB02, A1=IO01/MISO: PB03, A4=IO00/MOSI: PC11
	# PA01:PP:H, PB03:INPUP:H, PB02:PP:H, PC11:INPUP:H
	# Port A: PA01:PP:H
	mmw 0x40049004 0x00000100 0x00000626	;# PORTA_PCR01
	mmw 0x400FF000 0x00000002 0x00000000	;# PODR
	mmw 0x400FF014 0x00000002 0x00000000	;# PDDR
	# Port B: PB03:INPUP:H, PB02:PP:H
	mmw 0x4004A008 0x00000100 0x00000626	;# PORTB_PCR02
	mmw 0x4004A00C 0x00000103 0x00000624	;# PORTB_PCR03
	mmw 0x400FF040 0x0000000C 0x00000000	;# PODR
	mmw 0x400FF054 0x00000004 0x00000008	;# PDDR
	# Port C: PC11:INPUP:H
	mmw 0x4004B02C 0x00000103 0x00000624	;# PORTC_PCR11
	mmw 0x400FF080 0x00000800 0x00000000	;# PODR
	mmw 0x400FF094 0x00000000 0x00000800	;# PDDR

	# MB85RS64, D5=NCS: PA02, A0=SCLK: PB02, A1=IO01/MISO: PB03, A4=IO00/MOSI: PC11
	# PA02:PP:H, PB03:INPUP:H, PB02:PP:H, PC11:INPUP:H
	# Port A: PA02:PP:H
	mmw 0x40049008 0x00000100 0x00000626	;# PORTA_PCR02
	mmw 0x400FF000 0x00000004 0x00000000	;# PODR
	mmw 0x400FF014 0x00000004 0x00000000	;# PDDR
	# Port B: PB03:INPUP:H, PB02:PP:H
	mmw 0x4004A008 0x00000100 0x00000626	;# PORTB_PCR02
	mmw 0x4004A00C 0x00000103 0x00000624	;# PORTB_PCR03
	mmw 0x400FF040 0x0000000C 0x00000000	;# PODR
	mmw 0x400FF054 0x00000004 0x00000008	;# PDDR
	# Port C: PC11:INPUP:H
	mmw 0x4004B02C 0x00000103 0x00000624	;# PORTC_PCR11
	mmw 0x400FF080 0x00000800 0x00000000	;# PODR
	mmw 0x400FF094 0x00000000 0x00000800	;# PDDR

	# FM25V02, D4=NCS: PB23, A0=SCLK: PB02, A1=IO01/MISO: PB03, A4=IO00/MOSI: PC11
	#
	# MOSI and MISO pins *both* connected to PC11, hence PB03 actually not used
	#
	# PB23:PP:H, PB03:INPUP:H, PB02:PP:H, PC11:INPUP:H
	# Port B: PB23:PP:H, PB03:INPUP:H, PB02:PP:H
	mmw 0x4004A008 0x00000100 0x00000626	;# PORTB_PCR02
	mmw 0x4004A00C 0x00000103 0x00000624	;# PORTB_PCR03
	mmw 0x4004A05C 0x00000100 0x00000626	;# PORTB_PCR23
	mmw 0x400FF040 0x0080000C 0x00000000	;# PODR
	mmw 0x400FF054 0x00800004 0x00000008	;# PDDR
	# Port C: PC11:INPUP:H
	mmw 0x4004B02C 0x00000103 0x00000624	;# PORTC_PCR11
	mmw 0x400FF080 0x00000800 0x00000000	;# PODR
	mmw 0x400FF094 0x00000000 0x00000800	;# PDDR

	# FM25V05, D6=NCS: PC02, A0=SCLK: PB02, A1=IO01/MISO: PB03, A4=IO00/MOSI: PC11
	# PB03:INPUP:H, PB02:PP:H, PC11:INPUP:H, PC02:PP:H
	# Port B: PB03:INPUP:H, PB02:PP:H
	mmw 0x4004A008 0x00000100 0x00000626	;# PORTB_PCR02
	mmw 0x4004A00C 0x00000103 0x00000624	;# PORTB_PCR03
	mmw 0x400FF040 0x0000000C 0x00000000	;# PODR
	mmw 0x400FF054 0x00000004 0x00000008	;# PDDR
	# Port C: PC11:INPUP:H, PC02:PP:H
	mmw 0x4004B008 0x00000100 0x00000626	;# PORTC_PCR02
	mmw 0x4004B02C 0x00000103 0x00000624	;# PORTC_PCR11
	mmw 0x400FF080 0x00000804 0x00000000	;# PODR
	mmw 0x400FF094 0x00000004 0x00000800	;# PDDR

	#msoftspi set 1 w25q128 0x1000000 0x100 0x03 0x00 0x02 0xC7 0x10000 0xD8
	#msoftspi set 2 w25q256fv 0x2000000 0x100 0x03 0x00 0x02 0xC7 0x10000 0xD8
	msoftspi cmd 2 1 0x15; msoftspi cmd 2 0 0xB7; msoftspi cmd 2 1 0x15
	msoftspi set 3 m95640 0x2000 0x20 0x03 0x00 0x02
	msoftspi set 4 m95m02 0x40000 0x100 0x03 0x00 0x02
	msoftspi set 5 m95512 0x10000 0x80 0x03 0x00 0x02
	msoftspi set 6 fm25w256 0x8000 0x100 0x03 0x00 0x02
	#msoftspi set 7 mb85rs64 0x2000 0x100 0x03 0x00 0x02
	#msoftspi set 8 fm25v02 0x8000 0x100 0x03 0x00 0x02
	msoftspi set 9 fm25v05 0x10000 0x100 0x03 0x00 0x02
}

$_TARGETNAME configure -event reset-init {
	kinetis disable_wdog
	msoftspi_init
}
