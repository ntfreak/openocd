#

source [find target/swj-dp.tcl]

set _CHIPNAME pn7462

if { [info exists CCLK] } {
	# Allow user override
	set _CCLK $CCLK
} else {
	# rvee: note sure maybe 20Mhz
	set _CCLK 20000
}

# i obtained this with the 'dap info' command
if { [info exists CPUTAPID] } {
	# Allow user override
	set _CPUTAPID $CPUTAPID
} else {
	set _CPUTAPID 0x0bb11477
}

swj_newdap $_CHIPNAME cpu -irlen 4 -expected-id $_CPUTAPID
dap create $_CHIPNAME.dap -chain-position $_CHIPNAME.cpu

set _TARGETNAME $_CHIPNAME.cpu
target create $_TARGETNAME cortex_m -dap $_CHIPNAME.dap

set _IAP_ENTRY 0
if { [info exists IAP_ENTRY] } {
	set _IAP_ENTRY $IAP_ENTRY
}
set _FLASHNAME $_CHIPNAME.flash
flash bank $_FLASHNAME pn7462 0x203000 0x27800 0 128 $_TARGETNAME auto

set _EEPROMNAME $_CHIPNAME.eeprom
flash bank $_EEPROMNAME pn7462 0x201200 0xE00 0 64 $_TARGETNAME auto

adapter speed 10000

cortex_m reset_config sysresetreq

proc pn7462_program {filename args} {
	set doerase 0

	foreach arg $args {
		if {[string equal $arg "erase"]} {
			set doerase 1
		}
	}

	halt

	if {$doerase == 1} {
		echo "** Erasing flash before programming **"
		flash erase_sector 0 0 0
		flash erase_sector 1 0 0
	}

	program $filename verify
}

add_help_text pn7462_program "write an image (.hex) to flash and verifies. erase is optional (for reprogram only)."
add_usage_text pn7462_program "<filename> \[erase\]"